---
layout: post
title: "Ansible for Continuous Integration"
excerpt: "Your robot butler is simple, but not stupid"
tags: [Ansible, devops, ci, setup]
image:
# pic silver robot white skin handshake 1900x500
  feature: https://cloud.githubusercontent.com/assets/300046/14622149/306629f0-0585-11e6-961a-dc8f60dadbf6.jpg
  credit: 
  creditlink: 
comments: true
---
<i>{{ page.excerpt }}</i>
<hr />

{% include _toc.html %}

This section contains my notes on Ansible.

<a target="_blank" href="http://michaeldehaan.net/">
Michael DeHaan</a> from North Carolina (@laserllama)
began writing Ansible in his spare time while working at RedHat.

See his lightning talk at All Things Open Dec 3, 2014:

   * https://www.youtube.com/watch?v=2OiiaUgXrlE

See the <a target="_blank" href="https://speakerdeck.com/pycon2014 and https://github.com/PyCon/2014-slides">
slides</a> to his video "Python-Powered Radically Simple IT Automation" at PyCon 2014:

   * https://www.youtube.com/watch?time_continue=80&v=Qi0AhK7PMCI

Ansible is open-source under the 
<a target="_blank" href="https://github.com/ansible/ansible/">
github.com/ansible/ansible</a> organization on GitHub.
It is among the top 10 Python projects.
The GitHub Octoverse report for 2013 featured Ansible as being #5 on the list of open source projects with the most contributors. 

Its documentation is at
<a target="_blank" href="https://www.ansible.com/how-ansible-works/">
ansible.com</a>.

Comparisons Chef vs Puppet vs Ansible:
https://www.youtube.com/watch?v=miO00M4vPok

## How Ansible works #

The name Ansible is popularized by the movie 
Enders Game
for the device Ender uses to communicate with many ships galaxies away, in real-time.

Ansible's <strong>Control Server</strong> is what communicates with many remote servers to download and provision software locally in them.

   Communication is via SSH connections.
   So one does not need to beg for special ports to be opened through the enterprise firewall.

   An alternative is ZeroMQ.

   But plug-ins can enable communication via radio or other means.

   Rather than using a stored image (from say Artifactory),
   Ansible installs all packages on servers from scratch (does "bare metal provisioning").

By default, communication back to the Control Server is JSON messages.

(Internally, Ansible uses the Django-REST framework, PyYAML, Jinja2)


### .yml files in Git vs. database #

Instead of a database server, Ansible stores declarations in text files of yml format
that are both human machine readable.

Being text files, most enterprises put Ansible configuration files in a Git repository server (such as GitHub) so changes can be managed.

Rather than imperative commands (to do this and that in a specified sequence),
Ansible works by declarative definitions of <strong>desired state</strong>.

   It's like providing the destination address rather than directions to that location.

Ansible maintains a "model" of the IT infrastructure, with 
an <strong>inventory</strong> file listing remote machine hosts, such as:

   <pre>
   [webservers]
   192.168.33.20
   192.168.33.30
   [db]
   db-a.example.com
   </pre>

   This list can be dynamically generated from AWS, Azure, GCP, or from a CMDB.

To get the status of servers under [webservers] in the inventory file above:

   <tt><strong>
   ansible webservers -m ping 
   </strong></tt>

In addition to this ad-hoc run, Ansible can be run based on the contents of Playbooks with a command such as:

   <tt><strong>
   ansible-playbook <em>file.yml</em>
   </strong></tt>

Additionally, licensed product <a target="_blank" href="https://www.ansible.com/tower">
Ansible Tower</a>
runs playbooks for enterprises.

Next, let's look at examples of some Ansible playbook files.

### Modules in various languages #

Unlike Puppet, Ansible does not require agents to be installed and 
thus potentially leave residual bits on servers.

Various <strong>modules</strong> running on remote hosts
provide the plumbing for other networking protocols, such as HTTP, runing on remote machines.

   Modules are the "brains" of Ansible.

<a target="_blank" href="https://docs.ansible.com/ansible/modules_by_category.html">
List of available modules</a>.

Responses returned to the Ansible Control Server are in JSON messages.

Module development can be in any dynamic language, not just Python on the server.

   * Simplejson library on *NIX.
   * Windows Remote PowerShell 2.0 enabled.

Modules (hopefully written by following <a target="_blank" href="http://docs.ansible.com/ansible/developing_modules.html#testing-modules">
Module Development Guide</a>)
can be selected from various sources:

* <a target="_blank" href="https://github.com/ansible/ansible-modules-core">
   ansible-modules-core</a> are writtin Python.

* <a target="_blank" href="https://github.com/ansible/ansible-modules-extras">
   ansible-modules-extras</a>
   developed by others have slightly lower use or priority.

Server-side modules (action plugins)

## Playbooks #

Play behavior can be controlled several ways:
   with_items, failed_when, changed_when, until, ignore_errors

### Galaxy of sample configurations #

0. Use an internet browser to <a target="_blank" href="https://galaxy.ansible.com/explore#/">
galaxy.ansible.com/explore</a>

0. Search.
0. Open a sample playbook. ???

   Playbooks are defined in .yml files, which begin with three dashes in the first line.

   Playbooks define <strong>plays</strong>. consisting of one or a set of <strong>tasks</strong>.

   <strong>tasks</strong> invoke modules.

   Tasks trigger handlers which are run once at the end of plays.


An Ansible Config define Ansible control server configuration.

Notice the repos downloaded more than anyone is from 
@geerlingguy, Jeff Geerling (http://www.jeffgeerling.com/) 
has been using Ansible to manage infrastructure since early 2013, and
wrote <a target="_blank" href="http://www.ansiblefordevops.com/">ansiblefordevops.com</a>

Encrypted data within playbooks stored in GitHub can be unencrypted in memory using Ansible Vault.


## Roles #

<a target="_blank" href="http://docs.ansible.com/ansible/playbooks-roles.html">
Roles</a>
are self-contained with tasks, variables, configuration templates, etc.
 
<pre>
roles/
  webserver/
    tasks/
    handlers/
    files/
    templates/
    defaults/
    vars/
    meta/
</pre>

## Tasks #

<pre>
</pre>


## Prerequisites #

Ansible Control Server core is written in Python 2.6+ (not 3.0).
Thus, it can run natively on *NIX (Linux/Unix/Mac) - Windows not currently supported nor recommended.

However, you can run virtual instances on a Windows, Mac, or other native OS.

0. Download and install:

   * A virtual image manager from <a target="_blank" href="https://www.vagrantUp.com/">VagrantUp.com</a> (87.9 MB for vagrant_1.8.1.dmg).
   * A vm provider (hypervisor) to run virtual machines from Oracle's <a target="_blank" href="https://www.virtualbox.org/wiki/Downloads">
    VirtualBox</a>

0. Verify availability from a command-line:

   * vagrant
   * vboxmanager

0. Create a folder to hold Ansible resources. This can be in a git folder if you'd like version management.

0. Open <a target="_blank" href="https://www.vagrantcloud.com/">
   vagrantcloud.com</a> (which redirects to a site owned by hashicorp, who owns Vagrant).

0. In the box under "Discover Vagrant Boxes", search for <strong>ubuntu</strong> or CentOS, etc.

0. Choose one and copy its text in blue, such as "nrel/CentOS-6.5-x86_64" from contributor nrel or "ubuntu/trusty64".

0. Close down any process making use of port 8080, as that's Vagrant's default port.
   (Jenkins also uses port 8080 by default)

0. Initialize a Vagrantfile for use by Vagrant:

   <tt><strong>vagrant init</strong></tt>
   
   Sample response:

   <pre>
   A `Vagrantfile` has been placed in this directory. You are now
   ready to `vagrant up` your first virtual environment! Please read
   the comments in the Vagrantfile as well as documentation on
   `vagrantup.com` for more information on using Vagrant.
   </pre>

0. Open Vagrantfile in a text editor to end up with this sample content to specific the acs (Ancible Control Server),
   web, and db servers:

   {% highlight text %}
Vagrant.configure(2) do |config|

  config.vm.define "acs" do |acs|
    acs.vm.box = "nrel/CentOS-6.5-x86_64"
    acs.vm.hostname = "acs"
    acs.vm.network "private_network", ip: "192.168.33.10"
  end

  config.vm.define "web" do |web|
    web.vm.box="nrel/CentOS-6.5-x86_64"
    web.vm.hostname = "web"
    web.vm.network "private_network", ip: "192.168.33.20"
    web.vm.network "forwarded_port", guest: 80, host: 8080
  end

  config.vm.define "db" do |db|
    db.vm.box = "nrel/CentOS-6.5-x86_64"
    db.vm.hostname = "db"
    db.vm.network "private_network", ip: "192.168.33.30"
  end 
end
  {% endhighlight %}


  The above example makes use of internal IP addresses (192.168.33.xxx).

  It is modified from
  <a target="_blank" href="https://app.pluralsight.com/library/courses/hands-on-ansible/table-of-contents">
   Hands-on Ansible Pluralsight 3h 53m video course</a> 29 Dec 2015
   by Aaron Paxson | @Neelixx | myteneo.net 

   This tutorial presents related material in a different sequence for better understanding and updated.

0. Bring up machines based on the Vagrant file:

   <tt><strong>
   vagrant up
   </strong></tt>

   This can take several minutes, or even hours
   if this is the first time since images for servers specified need to be downloaded.


0. Switch to a Finder to see that a <strong>.vagrant</strong> (hidden) folder has been added.
   Under the <strong>machines</strong> folder is a folder for each type specified between pipe characters (acs, web, db, etc).

0. Open another terminal shell to check what is running:

   <tt><strong>
   vboxmanage list runningvms
   </strong></tt>

   The response is a hash:

   {% highlight text %}
   "ansible_acs_1463860205025_4852" {128ce450-8384-4adb-a4fd-7f4ac5c1f0b8}
   "ansible_web_1463862332570_44406" {dd044db3-ecf1-4b9b-9c42-96952172bd4d}
   "ansible_db_1463882256962_22323" {411c8704-f220-4188-8b94-d1bfb093e1b4}
   {% endhighlight %}

### Install Ansible on Control Server #

0. SSH into the acs server via vagrant:

   <tt><strong>vagrant ssh acs</strong></tt>

0. When you're ready:

   <tt><strong>
   exit
   </strong></tt>

0. On a CentOS or RHEL server:

   <tt><strong>sudo yum -y install ansible</strong></tt>

   Alternately, on a Debian Ubuntu server:

   <tt><strong>sudo apt-get -y install ansible</strong></tt>

0. Verify:

   <tt><strong>ansible --version</strong></tt>

## Compile #

0. Install enterprise release:

   <tt><strong></strong></tt>

## Updates #

Ansible achieves zero-downtime deployments with
multi-tear rolling updates to each specific node in a cluster.

This specifies taking 5 machines at a time out of a cluster:

   <pre>
   - hosts: webservers
     serial: 5

   pre_tasks:

   - name: take out of load balancer pool
     local_action: command /usr/bin/take_out_of_pool {{ inventory_hostname }}

  roles:
   - common
   - webserver
   - monitored

  post_tasks:
   - name: add back to load balancer pool
     local_action: command /usr/bin/add_back_to_pool {{ inventory_hostname }}
   </pre>


## Tasks #

<strong>tasks</strong> are executed from command line terminals.

They are shereable and repeatable.




## Install sample environment #

Install:


Ansible covers more functionality:

   * Provisioning - install software, patch security, copy files in, customize configurations, start web service.
   * Change management of configurations with configuration remediation.
   * Automation - make decisions. A single change can impact several machines.
   * Complex Orchestration of dependencies.

Ansible evaluates to mark changed states.

A function is Idempotent if repeated applications has the same affect as a single application.

### Steps during provisioning #

   0. Install OS 
   0. Install software
   0. Copy configurations
   0. Copy web files
   0. Install security updates
   0. Start web server

The precedence of configuration <strong>variables</strong> used to determine what overrides is this 
order of operations:

   0. $ANSIBLE_CONFIG
   0. ./ansible_cfg
   0. ~/ansible.cfg (home folder)
   0. /etc/ansible/ansible.cfg


## Community #

* Twitter: @ansible by Red Hat, @robynbergeron
* https://groups.google.com/forum/#!forum/ansible-announce
* On a IRC client, select Destination: Freenode, and add channel #ansible.
* AnsibleFest Texas

<a target="_blank" href="https://galaxy.ansible.com/explore#/">
Ansible-Galaxy.com/explore/</a> is the community hub to find and share reusable Ansible content.

0. Link to GitHub https://galaxy.ansible.com/accounts/github/login/
0. Confirm email.

## Resources #

* <a target="_blank" href="https://www.youtube.com/watch?v=Lxd6JMMxuwo">
   Getting Started With Jenkins</a> 
   edureka!

* <a target="_blank" href="https://www.ansible.com/quick-start-video">
  ansible.com/quick-start-video</a> provide your email because it is a high-level, high-flautin' marketing pitch which
  introduces Ansible Tower proprietary software.

Tim Gerla of Ansibleworks:

* <a target="_blank" href="https://www.youtube.com/watch?v=PDRdCqFp2sY">
   Continuous Deployment with Ansible USENIX</a> 38:38 on 11 Jul 2013
   by 

* <a target="_blank" href="https://www.youtube.com/watch?v=w8fOEEMqpOw">
    Ansible Hands-On Training</a>

* <a target="_blank" href="https://www.youtube.com/watch?v=w8fOEEMqpOw">
   Ansible Hands-On Training</a> 
   by Glen Jarvis
