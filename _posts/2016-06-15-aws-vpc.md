---
layout: post
title: "AWS Virtual Private Cloud (VPC)"
excerpt: "How to reach servers"
tags: [AWS, EC2, cloud, VPC]
image:
# feature: pic data center slice 1900x500.jpg
  feature: https://cloud.githubusercontent.com/assets/300046/14622043/8b1f9cce-0584-11e6-8b9f-4b6db5bb6e37.jpg
  credit:
  creditlink:
comments: true
---
<i>{{ page.excerpt }}</i>
<hr />

{% include _toc.html %}

This tutorial covers the creation of Virtual Private Clouds within AWS several different ways:

   1. Manually on the AWS Management Console.
   2. <a href="#CF-VPC">Automatically using CloudFormation</a>
   3. Automatically in shell scripts calling AWS CLI commands

VPCs are really software-defined networks (SDN).

We begin with the manual approach to cover PROTIPs and NOTEs in this our tutorial.

   * VPC Naming conventions
   * CIDR blocks.

<hr />

## Create VPCs using Management Console #

This chapter condenses <a target="_blank" href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Introduction.html">
Amazon's docs on this topic</a>
and adds additional PROTIPs and NOTEs.

0. A pre-requisite for this is my [AWS Basics tutorial](/aws-basics/)

   A default VPC is a pre-requisite for setting up an EC2 server instance.

0. At https://console.aws.amazon.com/vpc/

0. Select "Your VPC".

0. Click the "Create VPC" blue button.

0. For Name tag, consider a naming convention to include:

   * "dev", "qa", "prod" since many use isolated VPCs for different enviornments.

   * "public" or "private" network access.

0. For <a href="#CIDR">CIDR block, see below</a>.

   <a name="CIDR"></a>

   ### CIDR Subnet notation #

   <a name="Octets"></a>

   An example CIDR block looks like this:

   <pre><strong>
   10.0.1.0/18
   </strong></pre>

   PROTIP: To avoid naming conflicts, some organizations use a convention replacing the "1"
   in the address with other numbers for each separate environment and <strong>tier</strong>
   as well as duplicate zones:

   | Env | Tier | zone A | zone B | Privacy |
   | :-- | :--- | --- | --- | ------ |
   | Prd | ELB  |   1 |   11 | Public |
   | Prd | WEB  |   2 |   12 | Private |
   | Prd | APP  |   3 |   13 | Private |
   | Prd | Cache  |  4 |  14 | Private |
   | Prd | DB     |  5 |  15 | Private |
   | Dev | ELB  |   21 |  31 | Public |
   | Dev | WEB  |   22 |  32 | Private |
   | Dev | APP  |   23 |  33 | Private |
   | Dev | Cache  |  24 |  34 | Private |
   | Dev | DB     |  25 |  35 | Private |

   PROTIP: Use the table above to pre-define your own numbering scheme, which can also be used as shortcuts in other names.

   PROTIP: Some organizations allocate the bottom half of the 255 possibilities to private and upper half to public addresses:

   * private       10.1.0.0/24 &nbsp; (< 129)
   * public &nbsp; 10.129.0.0/24 (> 128)

   <a name="NonRouted"></a>

   Address ranges for private (non-routed) use (per <a target="_blank" href="http://info.internet.isi.edu/in-notes/rfc/files/rfc1918.txt">RFC 1918</a>):

   * 10.0.0.0 -> 10.255.255.255     within "Class A" addresses 1 -> 126
   * 172.16.0.0 -> 172.31.255.255   within "Class B" addresses 127 -> 191
   * 192.168.0.0 -> 192.168.255.255 within "Class C" addresses 192 -> 223
   <br /><br />

   <strong>The CIDR block for a default VPC is always 172.31.0.0/16.</strong>

   PROTIP: Use addresses from  different IP classes.
   For example, for the production site, use VPC CIDR 10.0.0.0/16 and for DR regions VPC CIDR 172.16.0.0/16.

   PROTIP: Carefully predict how many nodes each subnet might need.
   Once assigned, AWS VPC subnet blocks can’t be modified.
   If you find an established VPC is too small, you’ll need to terminate all of the instances of the VPC, delete it, and then create a new, larger VPC,
   then instantiate again.

   <a name="NetmaskNodes"></a>

   Refer to this table of nodes for each <strong>netmask</strong> Amazon allows:

   <table border="1">
   <tr><th align="right"> # Nodes </th><th align="center"> Netmask </th><th align="left"> Subnet Mask </th></tr>
   <tr><td align="right">     14 </td><td align="center"> /28 </td><td> 255.255.255.240 </td></tr>
   <tr><td align="right">     30 </td><td align="center"> /27 </td><td> 255.255.255.224 </td></tr>
   <tr><td align="right">     62 </td><td align="center"> /26 </td><td> 255.255.255.192 </td></tr>
   <tr><td align="right">    126 </td><td align="center"> /25 </td><td> 255.255.255.128 </td></tr>
   <tr><td align="right">    254 </td><td align="center"> /24 </td><td> 255.255.255.0   </td></tr>
   <tr><td align="right">    510 </td><td align="center"> /23 </td><td> 255.255.254.0   </td></tr>
   <tr><td align="right"> 65,534 </td><td align="center"> /16 </td><td> 255.255.255.240 </td></tr>
   </table>

   For example, if all you'll need are 14 nodes, specify `/28`.
   Notice that the larger the CIDR netmask, the less hosts in the subnet.

   #### Bucket of Candies Analogy #

   If you must know why, here is my analogy (best for kinesthetic learners):
   When we say a sports star makes a "7 figure salary", we figure out what that means with a table like this:

   | Figure:   |         7 |       6 |      5 |     4 |   3 |  2 |  1 |
   | --------- | --------: | ------: | -----: | ----: | --: | -: | -: |
   | # Values: | 1,000,000 | 100,000 | 10,000 | 1,000 | 100 | 10 |  1 |

   Now imagine a bucket for each figure level, a different size bucket containing candies of various colors and patterns, unique one for each possible value.
   People earning 7 figures can choose from the bucket holding a million possible values.

   If we add up the values (colors) possible in the right-most 3 buckets,
   we would have 100 + 10 + 1 = 111 possibilities.

   #### Counting in Base 2 #

   Instead of the way bankers do arithmetic
   where ten $1 bills is equivalent to a 10 dollar bill (called "base 10" or decimal calculation),
   computers count using "base 2" or binary arithmetic using 0's and 1's.
   So each of their "buckets" have a different number of possibility values:

   | Position:      |   8 |   7 |   6 |   5 |   4 |   3 |   2 |   1 |
   | -------------- | --: | --: | --: | --: | --: | --: | --: | --: |
   | # Values:      | 254 | 128 |  64 |  32 |  16 |   8 |   4 |   2 |
   | Cumulative possible addresses: | 510 | 254 | 126 |  62 |  30 |  14 |   6 |   2 |

   If we add up the possible addresses just from the <strong>right-most</strong> 3 buckets (from right to left),
   we would have 2 + 4 + 8 = 14 possibilities.

   Look back above at <a href="#NetmaskNodes">the table of nodes</a>,
   we see 14 possibilities can be obtained from a specification of 28 bits.

   This is all one needs to know to use AWS VPC.

   But if you would like to know how we get 3 buckets from the 28 bit specification,
   read on.

   #### IP address octets #

   IPV4 subnet addresses such as "127.10.138.128" are 4 sets of there are 32 "buckets" separated by dots into four 8 bit "octets":
   <amp-img width="600" height="72" alt="fig ip octets base 10 and 2-600x72.jpg"
layout="responsive" src="https://cloud.githubusercontent.com/assets/300046/16169053/db2765f8-34dc-11e6-8a62-68de3f320899.jpg"></amp-img>
   The 127 in the figure above is obtained by adding the base 10 value of each bit "bucket".
   Looking at a single octet of 8 bits:

   | "Bucket" position:                 |   8 |   7 |   6 |   5 |   4 |   3 |   2 |   1 |
   | ----------------                   | --: | --: | --: | --: | --: | --: | --: | --: |
   | Base 10 value of bucket:           | 128 |  64 |  32 |  16 |   8 |   4 |   2 |   1 |
   | Cumulative base 10 (left to right) | 255 | 127 |  63 |  31 |  15 |   7 |   3 |   1 |
   | Base 2 for 127 in base 10          |   1 |   1 |   0 |   1 |   1 |   0 |   0 |   1 |
   | Cumulative base 10 (left to right) | 217 |  89 |  25 |  25 |   9 |   1 |   1 |   1 |

   To translate a base 2 number of all 1's ("1111111") to a base 10 value of 255
   we accumulate base 10 values for each "bucket", left to right.

   To translate the Base 2 set of 1's and 0's to a base 10 number of 217,
   we accumulate the equivalent base 10 number at each position where there is a 1.

   Now let's look at the relationship between /28 and the "255.255.255.240" <strong>subnet mask</strong> associated with the /28
   in the <a href="#NetmaskNodes">table of nodes</a> above.

   The "240" base 10 number in the right-most quartet is equivalent to "11110000" in base 2.

   | "Bucket" position:                 |   8 |   7 |   6 |   5 |   4 |   3 |   2 |   1 |
   |  ----------------                  | --: | --: | --: | --: | --: | --: | --: | --: |
   | Base 10 value of bucket:           | 128 |  64 |  32 |  16 |   8 |   4 |   2 |   1 |
   | Base 2 for 240 in base 10          |   1 |   1 |   1 |   1 |   0 |   0 |   0 |   0 |
   | Cumulative base 10 (left to right) | 240 | 122 |  48 |  16 |   0 |   0 |   0 |   0 |

   Putting the three 255 and 240 together we get a continuous set of 1's followed by a set of four 0's:

   11111111.11111111.1111111.11110000

   The 1's "buckets" on the <strong>left side</strong> are used to address <strong>subnets</strong> managed by Amazon.

   The 0's buckets on the right side are used to address your individual nodes.

   NOTE: Although there are four 0's buckets, only 3 are used to specify node addreses becuase
   one digit is pre-allocated for network broadcast use (addresess containing all 0's and all 1's).

   More on CIDR (Classless Inter-Domain Routing), aka "supernetting":

   * http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario2.html

   * VLSM (Variable Length Subnet Mask)

   * https://cloudacademy.com/amazon-web-services/amazon-vpc-networking-course/build-and-configure-a-nat-instance.html



   <a href="#CF-VPC"></a>

   ## Automatically create VPC using CloudFormation #

   In the CF JSON to define a VPC, CF automatically populates the
   "VpcId" : { "Ref" : "VPC" },

   {% highlight text %}
     "Resources" : {
        "VPC" : {
         "Type" : "AWS::EC2::VPC",
         "Properties" : {
           "CidrBlock" : "10.0.0.0/16"
         }
       },

       "InternetGateway" : {
         "Type" : "AWS::EC2::InternetGateway",
         "Properties" : {
         }
       },

       "AttachGateway" : {
          "Type" : "AWS::EC2::VPCGatewayAttachment",
          "Properties" : {
            "VpcId" : { "Ref" : "VPC" },
            "InternetGatewayId" : { "Ref" : "InternetGateway" }
          }
       },
   {% endhighlight %}

      REMEMBER: There is one VPC per Availability Zone.

   A single Gateway serves all VPCs because that is the address
   the public DNS resolves corporate host names to.


   <a name="StaticIPs"></a>

   ## Static IPs #

   NOTE: The use of static IP addresses in configurations in EC2
   can be an annoyance to some and a comfort to others.

   Historically, working on a physical servers involves use of specific static IPs associated with particular purposes.
   External monitoring server was manually configured with the IP assigned to each machine.
   This also creates time pressure (panic) to get specific servers up and running.
   This led to pressure for servers to be patched rather than risking losing configurations during rebuilds.

   Static IPs needed to be protected as secrets because of their long-lived nature in traditional server environments.

   A "paradigm shift" in thinking is necessary when moving to the "cloud" because there IP address assignments can be transitory ephemeral.
   When a server dies in a "12 factor app" environment,
   additional servers can be brought up automatically by auto-scaling from a common public pool.

   AWS provides static IPs in their <strong>Elastic IP</strong> service.

      WARNING: AWS charges $1 per month for reserved static IPs that are not assigned to a running instance.

   PROTIP: Long-lived elastic static IPs are useful to
   avoid shared IPs that may have been black-listed due to abuse by others.

   Resources on this topic:

      * https://launchbylunch.com/posts/2014/Jan/29/aws-tips/
      * https://wblinks.com/notes/aws-tips-i-wish-id-known-before-i-started/


<a name="NAT"></a>

## NAT #

For security, define some servers can only make outbound calls to the internet (through the <a href="#NAT">NAT server</a>).

Bastion hosts ???


<a name="VPN"></a>

## VPN #

Configure <strong>Site to Site</strong> VPN to securely transfer data among Amazon VPCs in different regions or between Amazon VPC to your on-premise data center.


## VPC Peering #

Peering connections were introduced ___
to route traffic between two VPCs in the same region using <strong>private</strong> (rather than public) IP addresses.
This makes it like they are communicating as if they are within the same network.
Peering is neither a gateway nor a VPN connection,
so doesn't invoke separate physical hardware and the "single point of failure" nor bandwidth bottlenecks.
One useful use case is for more secure interconnection among Active Directory, Exchange, and other common business services.

   * more secure communication among business units/tams
   * stronger integration of CRM, HRMS, file sharing
   * tighter integrated access of core <strong>suppliers</strong> systems
   * provide monitoring and management of <strong>customer</strong> AWS resources


## ACLs #

Access Control Lists

  * Create Internet outbound allow and deny network ACL in your VPC.
   First network ACL: Allow all the HTTP and HTTPS outbound traffic on public internet facing subnet.
   Second network ACL: Deny all the HTTP/HTTPS traffic. Allow all the traffic to Squid proxy server or any virtual appliance.
   http://techlib.barracuda.com/display/BNGv54/How+to+Deploy+the+Barracuda+NG+Firewall+in+an+Amazon+Virtual+Private+Cloud


## NACLs #

Negative ACLS.

Block all the inbound and outbound ports. Only allow application request ports.

These are stateless traffic filters that apply to all traffic inbound or outbound from a Subnet within VPC. AWS recommended Outbound rules

See http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_NACLs.html



## Resources #

* Add Intrusion Prevention or Intrusion Detection virtual appliances to secure protocols and to take preventive/corrective action.

* Assign
* Configure <strong>Privileged Identity</strong> access management solutions to monitor and audit access by Administrators of your VPC.

* Add anti-virus for cleansing specific EC2 instances inside a VPC. Trend micro offers a product for this.

* http://harish11g.blogspot.com/2015/06/best-practices-tips-on-amazon-web-services-security-groups-aws-security-managed-services.html

AMS needs to set limits
http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_Limits.html


## More on Amazon #

This is one of a series on Amazon:

{% include aws_links.html %}
