---
layout: post
title: "AWS Virtual Private Cloud (VPC)"
excerpt: "How to reach servers"
tags: [AWS, EC2, cloud, VPC]
image:
# feature: pic data center slice 1900x500.jpg
  feature: https://cloud.githubusercontent.com/assets/300046/14622043/8b1f9cce-0584-11e6-8b9f-4b6db5bb6e37.jpg
  credit:
  creditlink:
comments: true
---
<i>{{ page.excerpt }}</i>
<hr />

{% include _toc.html %}

This tutorial covers the creation of Virtual Private Clouds within AWS two different ways:

1. Manually on the AWS Management Console.
2. <a href="#CF-VPC">Automatically using CloudFormation</a>

We begin with the manual approach to cover PROTIPs and NOTEs in this our tutorial.

   * VPC Naming conventions
   * CIDR blocks.

<hr />

## Create VPCs using Management Console #

This chapter condenses http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Introduction.html
and adds additional PROTIPs and NOTEs.

0. A pre-requisite for this is my [AWS Basics tutorial](/aws-basics/)

   A default VPC is a pre-requisite for setting up an EC2 server instance.

0. At https://console.aws.amazon.com/vpc/

0. Select "Your VPC".

0. Click the "Create VPC" blue button.

0. For Name tag, consider a naming convention:

   * "dev", "qa", "prod" since many use isolated VPCs for different enviornments.

   * "public" or "private" network access.

0. For <a href="#CIDR">CIDR block, see below</a>.



   VPCs are really software-defined networks (SDN).

For security, some servers can only make outbound calls to the internet (through the <a href="#NAT">NAT server</a>).

   REMEMBER: There is one VPC per Availability Zone.

A single Gateway serves all VPCs because that is the address
the public DNS resolves corporate host names to.




<a href="#CF-VPC"></a>

## Automatically create VPC using CloudFormation #

In the CF JSON to define a VPC, CF automatically populates the
"VpcId" : { "Ref" : "VPC" },

{% highlight text %}
  "Resources" : {
     "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16"
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
      }
    },

    "AttachGateway" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "VPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },
{% endhighlight %}


<a name="StaticIPs"></a>

NOTE: The use of static IP addresses in configurations in EC2
can be an annoyance to some and a comfort to others.

Historically, working on a physical servers involves use of specific static IPs associated with particular purposes.
External monitoring server was manually configured with the IP assigned to each machine.
This also creates time pressure (panic) to get specific servers up and running.
This led to pressure for servers to be patched rather than risking losing configurations during rebuilds.

Static IPs needed to be protected as secrets because of their long-lived nature in traditional server environments.

A "paradigm shift" in thinking is necessary when moving to the "cloud" because there IP address assignments can be transitory ephemeral.
When a server dies in a "12 factor app" environment,
additional servers can be brought up automatically by auto-scaling from a common public pool.

AWS provides static IPs in their <strong>Elastic IP</strong> service.

   WARNING: AWS charges $1 per month for reserved static IPs that are not assigned to a running instance.

PROTIP: Long-lived elastic static IPs are useful to
avoid shared IPs that may have been black-listed due to abuse by others.

Resources on this topic:

   * https://launchbylunch.com/posts/2014/Jan/29/aws-tips/
   * https://wblinks.com/notes/aws-tips-i-wish-id-known-before-i-started/


<a name="CIDR"></a>

### CIDR Subnet notation #

<a name="Octets"></a>

An example CIDR subnet looks like this:

   <pre>
   10.0.1.0/18
   </pre>

   A dot separates each of the 4 "octets".
   Each bucket can be from 1 to 253.
   Two of the values cannot be used for nodes because networks use addresses of all 0's nor all 1's for their own broadcasting.

   PROTIP: To avoid conflicts, some organizations use a convention replacing the "1"
   in the address with other numbers for each separate environment and <strong>tier</strong>:

   | Env | Tier | zone A | zone B |
   | :-- | :--- | --- | --- |
   | Prd | ELB  |   1 |   11 |
   | Prd | WEB  |   2 |   12 |
   | Prd | APP  |   3 |   13 |
   | Prd | Cache  |  4 |  14 |
   | Prd | DB     |  5 |  15 |
   | Dev | ELB  |   21 |  31 |
   | Dev | WEB  |   22 |  32 |
   | Dev | APP  |   23 |  33 |
   | Dev | Cache  |  24 |  34 |
   | Dev | DB     |  25 |  35 |

   PROTIP: Use the table above to pre-define your own numbering scheme, which can also be used as shortcuts in other names.

   Alternately:

   PROTIP: Some organizations allocate the bottom half of the 255 possibilities to private and upper half to public addresses:

   * private       10.1.0.0/24 &nbsp; (< 129)
   * public &nbsp; 10.129.0.0/24 (> 128)

<a name="NonRouted"></a>

Address ranges for private (non-routed) use (per <a target="_blank" href="http://info.internet.isi.edu/in-notes/rfc/files/rfc1918.txt">RFC 1918</a>):

   * 10.0.0.0 -> 10.255.255.255     within "Class A" addresses 1 -> 126
   * 172.16.0.0 -> 172.31.255.255   within "Class B" addresses 127 -> 191
   * 192.168.0.0 -> 192.168.255.255 within "Class C" addresses 192 -> 223

   <strong>The CIDR block for a default VPC is always 172.31.0.0/16.</strong>

   PROTIP: Use addresses from  different IP classes.
   For example, for the production site, use VPC CIDR 10.0.0.0/16 and for DR regions VPC CIDR 172.16.0.0/16.

PROTIP: Carefully predict how many nodes each subnet might need.
Once assigned, AWS VPC subnet blocks can’t be modified.
If you find an established VPC is too small, you’ll need to terminate all of the instances of the VPC, delete it, and then create a new, larger VPC,
then instantiate again.

<a name="NetmaskNodes"></a>

Refer to this table of nodes for each <strong>netmask</strong> Amazon allows:

   <table border="1">
   <tr><th align="right"> # Nodes </th><th align="center"> Netmask </th><th align="left"> Subnet Mask </th></tr>
   <tr><td align="right">     14 </td><td align="center"> /28 </td><td> 255.255.255.240 </td></tr>
   <tr><td align="right">     30 </td><td align="center"> /27 </td><td> 255.255.255.224 </td></tr>
   <tr><td align="right">     62 </td><td align="center"> /26 </td><td> 255.255.255.192 </td></tr>
   <tr><td align="right">    126 </td><td align="center"> /25 </td><td> 255.255.255.128 </td></tr>
   <tr><td align="right">    254 </td><td align="center"> /24 </td><td> 255.255.255.0   </td></tr>
   <tr><td align="right">    510 </td><td align="center"> /23 </td><td> 255.255.254.0   </td></tr>
   <tr><td align="right"> 65,534 </td><td align="center"> /16 </td><td> 255.255.255.240 </td></tr>
   </table>

   For example, if all you'll need are 14 nodes, specify `/28`.
   Notice that the larger the CIDR netmask, the less hosts in the subnet.

   #### Bucket of Candies Analogy #

   If you must know why, here is my analogy (best for kinesthetic learners):
   When we say a sports star makes a "7 figure salary", we figure out what that means with a table like this:

   | Figure: |         7 |       6 |      5 |     4 |   3 |  2 |  1 |
   | ------- | --------: | ------: | -----: | ----: | --: | -: | -: |
   | Values: | 1,000,000 | 100,000 | 10,000 | 1,000 | 100 | 10 |  1 |

   Now imagine a bucket for each figure level, a different size bucket containing candies of various colors and patterns, unique one for each possible value.
   People earning 7 figures can choose from the bucket holding a million possible values.

   If we add up the values (colors) possible in the right-most 3 buckets,
   we would have 100 + 10 + 1 = 111 possibilities.

   #### Counting in Base 2 #

   Instead of the way banks use to do arithmetic (called "base 10" or decimal calculations),
   where ten $1 bills is equivalent to a 10 dollar bill,
   computers count using "base 2" or binary arithmetic using 0's and 1's.
   So each of their "buckets" have a different number of possibility values:

   | Figure:        |   8 |   7 |   6 |   5 |   4 |   3 |   2 |   1 |
   | -------------- | --: | --: | --: | --: | --: | --: | --: | --: |
   | Values:        | 254 | 128 |  64 |  32 |  16 |   8 |   4 |   2 |
   | Possibilities: | 510 | 254 | 126 |  62 |  30 |  14 |   6 |   2 |

   If we add up the values possibles in the <strong>right-most</strong> 3 buckets,
   we would have 8 + 4 + 2 = 14 possibilities.

   Look back above at <a href="#NetmaskNodes">the table of nodes</a>.
   Again, 14 possibilities.

   The buckets on the <strong>left side</strong> "buckets" are used to identify <strong>subnets</strong> managed by Amazon rather than indiviual nodes.


More on CIDR (Classless Inter-Domain Routing), aka "supernetting":

   * http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario2.html

   * VLSM (Variable Length Subnet Mask)

   * https://cloudacademy.com/amazon-web-services/amazon-vpc-networking-course/build-and-configure-a-nat-instance.html


<a name="VPN"></a>

## VPN #

Configure <strong>Site to Site</strong> VPN to securely transfer data among Amazon VPCs in different regions or between Amazon VPC to your on-premise data center.


## VPC Peering #

Peering connections were introduced ___
to route traffic between two VPCs in the same region using <strong>private</strong> (rather than public) IP addresses.
This makes it like they are communicating as if they are within the same network.
Peering is neither a gateway nor a VPN connection,
so doesn't invoke separate physical hardware and the "single point of failure" nor bandwidth bottlenecks.
One useful use case is for more secure interconnection among Active Directory, Exchange, and other common business services.

   * more secure communication among business units/tams
   * stronger integration of CRM, HRMS, file sharing
   * tighter integrated access of core <strong>suppliers</strong> systems
   * provide monitoring and management of <strong>customer</strong> AWS resources


## ACLs #

Access Control Lists

  * Create Internet outbound allow and deny network ACL in your VPC.
   First network ACL: Allow all the HTTP and HTTPS outbound traffic on public internet facing subnet.
   Second network ACL: Deny all the HTTP/HTTPS traffic. Allow all the traffic to Squid proxy server or any virtual appliance.
   http://techlib.barracuda.com/display/BNGv54/How+to+Deploy+the+Barracuda+NG+Firewall+in+an+Amazon+Virtual+Private+Cloud


## NACLs #

Negative ACLS.

Block all the inbound and outbound ports. Only allow application request ports.

These are stateless traffic filters that apply to all traffic inbound or outbound from a Subnet within VPC. AWS recommended Outbound rules

See http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_NACLs.html



## Resources #

* Add Intrusion Prevention or Intrusion Detection virtual appliances to secure protocols and to take preventive/corrective action.

* Assign
* Configure <strong>Privileged Identity</strong> access management solutions to monitor and audit access by Administrators of your VPC.

* Add anti-virus for cleansing specific EC2 instances inside a VPC. Trend micro offers a product for this.

* http://harish11g.blogspot.com/2015/06/best-practices-tips-on-amazon-web-services-security-groups-aws-security-managed-services.html

AMS needs to set limits
http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_Limits.html


## More on Amazon #

This is one of a series on Amazon:

{% include aws_links.html %}
